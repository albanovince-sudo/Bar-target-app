<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Obiettivo Mensile — Bar</title>

  <!-- Icona (metti icon.png nella root del repo) -->
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --brand:#ff7a00;
      --bg:#fff8f0;
      --card:#ffffff;
      --ink:#1f1f1f;
      --muted:#6b6b6b;
      --ring:#e9e9e9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{background:var(--brand);color:#fff;padding:16px;font-weight:bold;font-size:18px}
    main{max-width:900px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:14px}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:16px;margin-top:14px}
    h2{margin-top:0}
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    input{width:100%;padding:10px;border:1px solid var(--ring);border-radius:10px;font-size:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .row>*{flex:1}
    .btn{cursor:pointer;border:0;padding:10px 12px;border-radius:10px;font-weight:600;background:#f0f0f0}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.danger{background:#e53935;color:#fff}
    .progress-wrap{background:#eee;border-radius:999px;overflow:hidden;height:18px;margin-top:8px}
    .progress{background:var(--brand);height:100%;width:0%;color:#fff;text-align:center;font-size:12px;line-height:18px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
    th{background:#fafafa}
    .admin-badge{font-size:12px;background:#eee;padding:6px 10px;border-radius:999px;margin-left:8px}
    .admin-btn{background:#f0f0f0;color:#222;border:0;padding:10px 12px;border-radius:10px;cursor:pointer}
  </style>
</head>
<body>
  <header>📊 Obiettivo Mensile — Bar</header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>Impostazioni</h2>
        <label>Obiettivo mensile (€)</label>
        <div class="row">
          <input type="number" id="goalInput" placeholder="es. 30000">
          <button class="btn primary" id="saveGoalBtn">Imposta</button>
        </div>
        <div class="row">
          <input type="date" id="dateInput">
          <input type="number" id="amountInput" placeholder="Incasso giornaliero">
        </div>
        <div class="row">
          <button class="btn primary" id="addBtn">Aggiungi</button>
        </div>
      </section>

      <section class="card">
        <h2>Stato del mese</h2>
        <p>Obiettivo: <span id="goalVal">€0</span></p>
        <p>Totale incassi: <span id="totalVal">€0</span></p>
        <p>Bonus 5%: <span id="bonusVal">€0</span></p>
        <div class="progress-wrap">
          <div class="progress" id="progressBar">0%</div>
        </div>
        <div class="row">
          <button class="btn" id="exportBtn">Esporta CSV</button>
          <button class="btn danger" id="resetBtn">Reset</button>
        </div>
      </section>
    </div>

    <section class="card">
      <h2>Storico giornaliero</h2>
      <canvas id="chart" height="200"></canvas>
    </section>

    <section class="card">
      <h2>Dettagli incassi</h2>
      <table>
        <thead><tr><th>Data</th><th>Incasso</th><th></th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </main>

  <script>
    // === Utility & Storage ===
    const fmt = n=> new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(Number(n||0));
    const monthKey = d=> d.toISOString().slice(0,7);
    let currentMonth = monthKey(new Date());
    function kGoal(m){return `goal:${m}`}
    function kEntries(m){return `entries:${m}`}
    function loadGoal(m){return Number(localStorage.getItem(kGoal(m))||0)}
    function saveGoal(m,v){localStorage.setItem(kGoal(m),String(v))}
    function loadEntries(m){return JSON.parse(localStorage.getItem(kEntries(m))||'[]')}
    function saveEntries(m,arr){localStorage.setItem(kEntries(m),JSON.stringify(arr))}

    // === UI refs ===
    const goalInput=document.getElementById('goalInput');
    const saveGoalBtn=document.getElementById('saveGoalBtn');
    const dateInput=document.getElementById('dateInput');
    const amountInput=document.getElementById('amountInput');
    const addBtn=document.getElementById('addBtn');
    const resetBtn=document.getElementById('resetBtn');
    const exportBtn=document.getElementById('exportBtn');
    const goalVal=document.getElementById('goalVal');
    const totalVal=document.getElementById('totalVal');
    const bonusVal=document.getElementById('bonusVal');
    const progressBar=document.getElementById('progressBar');
    const rows=document.getElementById('rows');

    // === Chart ===
    const ctx=document.getElementById('chart').getContext('2d');
    let chart=new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'Incasso (€)',data:[],backgroundColor:'#ff7a00'}]},options:{scales:{y:{beginAtZero:true}}}});

    // === Funzioni ===
    function render(){
      const goal=loadGoal(currentMonth);
      const entries=loadEntries(currentMonth);
      goalInput.value=goal||'';
      goalVal.textContent=fmt(goal);
      const total=entries.reduce((s,e)=>s+Number(e.amount),0);
      totalVal.textContent=fmt(total);
      bonusVal.textContent=fmt(total*0.05);
      let pct=goal>0?Math.min(100,(total/goal)*100):0;
      progressBar.style.width=pct+'%';
      progressBar.textContent=Math.floor(pct)+'%';
      // tabella
      rows.innerHTML='';
      entries.forEach((e,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${e.date}</td><td>${fmt(e.amount)}</td><td><button data-i="${i}">Elimina</button></td>`;
        rows.appendChild(tr);
      });
      rows.querySelectorAll('button').forEach(btn=>{
        btn.onclick=()=>{if(!isAdmin){alert('Solo Admin');return;}
          const arr=loadEntries(currentMonth);arr.splice(btn.dataset.i,1);saveEntries(currentMonth,arr);render();}
      });
      // chart
      const byDay={};entries.forEach(e=>{byDay[e.date]=(byDay[e.date]||0)+Number(e.amount)});
      const labels=Object.keys(byDay).sort();const data=labels.map(d=>byDay[d]);
      chart.data.labels=labels;chart.data.datasets[0].data=data;chart.update();
    }

    function addEntry(dateStr,amount){
      if(!isAdmin){alert('Solo Admin');return;}
      if(!dateStr||!(amount>0))return;
      const arr=loadEntries(currentMonth);arr.push({date:dateStr,amount:Number(amount)});
      saveEntries(currentMonth,arr);amountInput.value='';render();
    }

    // === Eventi ===
    saveGoalBtn.onclick=()=>{if(!isAdmin){alert('Solo Admin');return;}
      const v=Number(goalInput.value);if(!(v>0))return;saveGoal(currentMonth,v);render();}
    addBtn.onclick=()=>addEntry(dateInput.value,amountInput.value);
    resetBtn.onclick=()=>{if(!isAdmin){alert('Solo Admin');return;}
      if(confirm('Cancellare tutto?')){saveEntries(currentMonth,[]);render();}}
    exportBtn.onclick=()=>{
      const arr=loadEntries(currentMonth);let csv='Data,Incasso\n'+arr.map(e=>`${e.date},${e.amount}`).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download=`incassi_${currentMonth}.csv`;a.click();URL.revokeObjectURL(url);
    }

    // === Admin con PIN ===
    let isAdmin=localStorage.getItem('isAdmin')==='true';
    const bar=document.createElement('div');
    bar.style.textAlign='center';bar.style.margin='16px';
    const adminBtn=document.createElement('button');
    adminBtn.className='admin-btn';
    const badge=document.createElement('span');
    badge.className='admin-badge';
    function updateAdminUI(){
      adminBtn.textContent=isAdmin?'🔓 Esci Admin':'🔐 Login Admin';
      badge.textContent=isAdmin?'ADMIN':'sola lettura';
      badge.style.background=isAdmin?'#ffe3cc':'#eee';
    }
    adminBtn.onclick=()=>{
      if(isAdmin){isAdmin=false;localStorage.setItem('isAdmin','false');updateAdminUI();alert('Logout Admin')}
      else{const pin=prompt('Inserisci PIN:');if(pin==='1234'){isAdmin=true;localStorage.setItem('isAdmin','true');updateAdminUI();alert('Accesso Admin')}
      else alert('PIN errato');}}
    updateAdminUI();
    bar.appendChild(adminBtn);bar.appendChild(badge);document.body.appendChild(bar);

    // init
    (function init(){const today=new Date();dateInput.value=today.toISOString().slice(0,10);render();})();
  </script>
</body>
</html>