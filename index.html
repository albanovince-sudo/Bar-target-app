<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Obiettivo Mensile — Mast</title>

  <!-- Icona iOS (carica icon.png nella root se vuoi un’icona personalizzata) -->
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --navy:#0d1b2a;        /* navy principale */
      --navy-2:#1b263b;      /* navy secondario */
      --accent:#3a7bd5;      /* blu acceso */
      --bg:#f5f7fb;          /* sfondo chiaro */
      --card:#ffffff;
      --ink:#0d1b2a;
      --muted:#6b7280;
      --ring:#e6e8ef;
      --green:#16a34a;       /* verde bonus */
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* HEADER */
    header{
      background: linear-gradient(135deg, var(--navy), var(--navy-2));
      color:#fff; padding:14px 16px; position:sticky; top:0; z-index:10;
      box-shadow:0 4px 16px rgba(0,0,0,.15);
    }
    .head-wrap{max-width:980px;margin:0 auto;display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:8px;overflow:hidden;
      display:flex;align-items:center;justify-content:center;background:#ffffff12;
      border:1px solid #ffffff22
    }
    .logo img{max-width:100%;max-height:100%;display:block}
    .title{margin:0; font-weight:800; letter-spacing:.2px; font-size:18px; line-height:1.2}
    .subtitle{margin:2px 0 0 0; color:#c9d6ff; font-size:12px}

    main{max-width:980px;margin:0 auto;padding:16px}

    .card{
      background:var(--card); border:1px solid var(--ring); border-radius:14px; padding:16px;
      box-shadow:0 6px 18px rgba(13,27,42,.06);
    }
    h2{margin:0 0 8px 0;font-size:18px;color:var(--navy)}
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    input[type="number"],input[type="date"]{
      width:100%;padding:12px;border:1px solid var(--ring);border-radius:10px;font-size:16px;background:#fff;outline:none
    }
    input:focus{border-color:var(--accent)}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .row>*{flex:1}

    .btn{
      cursor:pointer;border:0;padding:10px 12px;border-radius:10px;font-weight:700;background:#eef2ff;color:#0d1b2a
    }
    .btn.primary{background:var(--accent);color:#fff}
    .btn.danger{background:#e63946;color:#fff}

    .kpi{display:flex;justify-content:space-between;align-items:baseline;margin:6px 0}
    .kpi .label{color:var(--muted);font-size:14px}
    .kpi .value{font-weight:800;font-size:22px}

    .progress-wrap{background:#e9edf7;border-radius:999px;overflow:hidden;height:18px;margin-top:8px}
    .progress{background:var(--accent);height:100%;width:0%;color:#fff;text-align:center;font-size:12px;line-height:18px;transition:width .35s}

    /* Mese nav */
    .monthNav{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background:var(--card); border:1px solid var(--ring); border-radius:14px; padding:12px;
      box-shadow:0 6px 18px rgba(13,27,42,.06); margin-top:14px; margin-bottom:14px;
    }
    .pill{padding:6px 12px;background:#e9edf7;border-radius:999px;font-weight:800;color:var(--navy)}

    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{padding:8px;border-bottom:1px dashed #e6e8ef;text-align:center}
    th{background:#f7f8fc;color:#556; font-weight:700}

    .admin-badge{font-size:12px;background:#e9edf7;padding:6px 10px;border-radius:999px;margin-left:8px}
    .admin-btn{background:#eef2ff;color:#0d1b2a;border:0;padding:10px 12px;border-radius:10px;cursor:pointer}

    /* Bonus verde */
    .green{color:var(--green)}

    /* Campo incasso più piccolo */
    .amount-wrap{flex:0 0 180px}   /* larghezza fissa più piccola */
    .amount-wrap input{width:100%}

    footer{padding:24px 16px;color:#7b849a;text-align:center}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="head-wrap">
      <div class="logo">
        <!-- Carica un file logo.png nella root del repo -->
        <img src="logo.png" alt="Logo Mast" onerror="this.style.display='none'">
      </div>
      <div>
        <p class="title">📊 Obiettivo Mensile — Mast</p>
        <p class="subtitle">Dashboard interna • lettura per tutti, scrittura con PIN admin</p>
      </div>
    </div>
  </header>

  <main>
    <!-- Navigazione mese -->
    <div class="monthNav">
      <button class="btn" id="prevBtn">◀︎ Mese prec.</button>
      <div class="pill" id="monthLabel">Mese Anno</div>
      <button class="btn" id="nextBtn">Mese succ. ▶︎</button>
    </div>

    <!-- 1) STATO DEL MESE (spostato in ALTO) -->
    <section class="card">
      <h2>Stato del mese</h2>
      <div class="kpi"><div class="label">Obiettivo</div><div class="value" id="goalVal">€0</div></div>
      <div class="kpi"><div class="label">Incassi totali</div><div class="value" id="totalVal">€0</div></div>
      <div class="kpi">
        <div class="label green">Bonus 3%</div>
        <div class="value green" id="bonusVal">€0</div>
      </div>

      <div class="progress-wrap"><div class="progress" id="progressBar">0%</div></div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="exportBtn">⬇︎ Esporta CSV</button>
        <button class="btn danger" id="resetBtn">🔄 Reset mese</button>
      </div>
    </section>

    <!-- 2) GRAFICO -->
    <section class="card">
      <h2>Storico giornaliero</h2>
      <div style="height:220px"><canvas id="chart"></canvas></div>
    </section>

    <!-- 3) TABELLA -->
    <section class="card">
      <h2>Dettagli incassi</h2>
      <table>
        <thead><tr><th>Data</th><th>Incasso (€)</th><th></th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </section>

    <!-- 4) IMPOSTAZIONI & INSERIMENTO (spostato come ULTIMO BOX) -->
    <section class="card">
      <h2>Impostazioni & Inserimento</h2>
      <label>Obiettivo mensile (€)</label>
      <div class="row">
        <input type="number" id="goalInput" placeholder="es. 30000" min="0" step="0.01">
        <button class="btn primary" id="saveGoalBtn">Imposta</button>
      </div>

      <div class="row">
        <div>
          <label>Data</label>
          <input type="date" id="dateInput">
        </div>
        <div class="amount-wrap">
          <label>Incasso giornaliero (€)</label>
          <input type="number" id="amountInput" placeholder="es. 500" min="0" step="0.01">
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="addBtn">Aggiungi</button>
        <button class="btn" id="quick50" type="button">+50</button>
        <button class="btn" id="quick100" type="button">+100</button>
      </div>

      <p class="muted" style="margin-top:6px">I dati sono salvati sul dispositivo (localStorage) per mese.</p>
    </section>
  </main>

  <footer>© Mast — uso interno</footer>

  <script>
    /* ==== Utility & Storage ==== */
    const fmt = n => new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(Number(n||0));

    // Calcolo mese corrente in stringa "YYYY-MM" senza problemi di fuso orario
    function getCurrentYM(){
      const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); return `${y}-${m}`;
    }
    function addMonths(ym, delta){
      let [y,m]=ym.split('-').map(Number);
      m+=delta;
      while(m<1){ m+=12; y--; }
      while(m>12){ m-=12; y++; }
      return `${y}-${String(m).padStart(2,'0')}`;
    }
    let currentMonth = getCurrentYM();

    const kGoal    = m => `mast:goal:${m}`;
    const kEntries = m => `mast:entries:${m}`;
    const loadGoal    = m => Number(localStorage.getItem(kGoal(m))||0);
    const saveGoal    = (m,v) => localStorage.setItem(kGoal(m), String(v));
    const loadEntries = m => { try { return JSON.parse(localStorage.getItem(kEntries(m))||'[]') } catch(_) { return [] } };
    const saveEntries = (m,arr) => localStorage.setItem(kEntries(m), JSON.stringify(arr));

    /* ==== UI refs ==== */
    const monthLabel = document.getElementById('monthLabel');
    const goalInput  = document.getElementById('goalInput');
    const saveGoalBtn= document.getElementById('saveGoalBtn');
    const dateInput  = document.getElementById('dateInput');
    const amountInput= document.getElementById('amountInput');
    const addBtn     = document.getElementById('addBtn');
    const resetBtn   = document.getElementById('resetBtn');
    const exportBtn  = document.getElementById('exportBtn');
    const quick50    = document.getElementById('quick50');
    const quick100   = document.getElementById('quick100');
    const goalVal    = document.getElementById('goalVal');
    const totalVal   = document.getElementById('totalVal');
    const bonusVal   = document.getElementById('bonusVal');
    const progressBar= document.getElementById('progressBar');
    const rows       = document.getElementById('rows');
    const prevBtn    = document.getElementById('prevBtn');
    const nextBtn    = document.getElementById('nextBtn');

    /* ==== Chart ==== */
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx,{
      type:'bar',
      data:{labels:[],datasets:[{label:'Incasso (€)',data:[],backgroundColor:'#3a7bd5'}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
    });

    /* ==== Admin PIN ==== */
    let isAdmin = localStorage.getItem('mast:isAdmin') === 'true';
    function requireAdmin(){ if(isAdmin) return true; alert('Solo Admin può eseguire questa azione.'); return false; }

    // Barra admin (login/logout + badge)
    (function(){
      const bar = document.createElement('div');
      bar.style.display='flex'; bar.style.justifyContent='center'; bar.style.margin='14px 0';
      const btn = document.createElement('button'); btn.className='admin-btn';
      const badge = document.createElement('span'); badge.className='admin-badge';

      function update(){
        btn.textContent = isAdmin ? '🔓 Esci Admin' : '🔐 Login Admin';
        badge.textContent = isAdmin ? 'ADMIN' : 'sola lettura';
        badge.style.background = isAdmin ? '#dbeafe' : '#e9edf7';
      }
      btn.onclick = ()=>{
        if(isAdmin){ isAdmin=false; localStorage.setItem('mast:isAdmin','false'); update(); alert('Logout Admin'); }
        else{
          const pin = prompt('Inserisci PIN:');
          if(pin==='1234'){ // <-- CAMBIA QUI IL PIN
            isAdmin=true; localStorage.setItem('mast:isAdmin','true'); update(); alert('Accesso Admin');
          } else if(pin!==null){ alert('PIN errato'); }
        }
      };
      update(); bar.appendChild(btn); bar.appendChild(badge);
      document.body.appendChild(bar);
    })();

    /* ==== Logica ==== */
    function setMonth(ym){
      currentMonth = ym;
      const [yy,mm] = ym.split('-'); const mesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
      monthLabel.textContent = mesi[Number(mm)-1] + ' ' + yy;

      // Imposta la data di input coerente con il mese mostrato
      const now = getCurrentYM();
      if(ym !== now){
        dateInput.value = `${ym}-01`;
      }else{
        const t=new Date(), y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
        dateInput.value = `${y}-${m}-${d}`;
      }

      render();
    }

    function render(){
      const goal = loadGoal(currentMonth);
      const entries = loadEntries(currentMonth);

      goalInput.value = goal || '';
      goalVal.textContent = fmt(goal);

      const total = entries.reduce((s,e)=> s + Number(e.amount||0), 0);
      totalVal.textContent = fmt(total);
      bonusVal.textContent = fmt(total * 0.03);   // BONUS 3%

      const pct = goal>0 ? Math.min(100, (total/goal)*100) : 0;
      progressBar.style.width = pct.toFixed(1) + '%';
      progressBar.textContent = Math.floor(pct) + '%';

      // Tabella
      rows.innerHTML = '';
      entries.slice().sort((a,b)=>a.date.localeCompare(b.date)).forEach((e,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${e.date}</td><td>${fmt(e.amount)}</td><td><button class="btn" data-i="${i}">Elimina</button></td>`;
        rows.appendChild(tr);
      });
      rows.querySelectorAll('button[data-i]').forEach(btn=>{
        btn.onclick = ()=>{
          if(!requireAdmin()) return;
          const arr = loadEntries(currentMonth);
          arr.splice(Number(btn.dataset.i),1);
          saveEntries(currentMonth, arr);
          render();
        };
      });

      // Grafico
      const byDay = {};
      for(const e of entries){ byDay[e.date] = (byDay[e.date]||0) + Number(e.amount||0); }
      const labels = Object.keys(byDay).sort();
      const data = labels.map(d=> byDay[d]);
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
    }

    function addEntry(dateStr, amount){
      if(!requireAdmin()) return;
      const val = Number(amount);
      if(!dateStr || !(val>0)){ alert('Inserisci una data e un importo valido'); return; }

      // Se la data è di un altro mese, cambia il contesto mese automaticamente
      const m = dateStr.slice(0,7);
      if(m !== currentMonth){ setMonth(m); }

      const arr = loadEntries(currentMonth);
      arr.push({date:dateStr, amount:val});
      saveEntries(currentMonth, arr);
      amountInput.value = '';
      render();
    }

    /* ==== Eventi ==== */
    document.getElementById('exportBtn').onclick = ()=>{
      const entries = loadEntries(currentMonth);
      if(!entries.length){ alert('Nessun dato'); return; }
      let csv = 'Data,Incasso\n' + entries
        .sort((a,b)=>a.date.localeCompare(b.date))
        .map(e=> `${e.date},${Number(e.amount).toFixed(2)}`).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`incassi_${currentMonth}.csv`; a.click();
      URL.revokeObjectURL(url);
    };

    saveGoalBtn.onclick = ()=>{
      if(!requireAdmin()) return;
      const v = Number(goalInput.value);
      if(!(v>0)){ alert('Obiettivo > 0'); return; }
      saveGoal(currentMonth, v);
      render();
      alert('Obiettivo salvato');
    };

    addBtn.onclick = ()=> addEntry(dateInput.value, amountInput.value);
    quick50.onclick  = ()=>{ amountInput.value='50';  addBtn.click(); };
    quick100.onclick = ()=>{ amountInput.value='100'; addBtn.click(); };

    resetBtn.onclick = ()=>{
      if(!requireAdmin()) return;
      if(confirm('Cancellare tutti i dati del mese corrente?')){
        saveEntries(currentMonth, []);
        render();
      }
    };

    // Navigazione mese: usa addMonths() per evitare salti doppi
    prevBtn.onclick = ()=> setMonth(addMonths(currentMonth, -1));
    nextBtn.onclick = ()=> setMonth(addMonths(currentMonth,  1));

    /* ==== Avvio ==== */
    (function init(){
      // Data odierna nel campo data
      const t=new Date(), y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
      dateInput.value = `${y}-${m}-${d}`;
      setMonth(currentMonth);
    })();
  </script>
</body>
</html>